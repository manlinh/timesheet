<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Timesheet ç¶²é </title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    textarea { width: 100%; height: 100px; }
    button { margin-top: 10px; }
    #messages { margin-top: 2em; }
    .msg { margin-bottom: 1em; padding: 0.5em; border-bottom: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>ğŸ—“ï¸ å¤ä»¤ç‡Ÿç•™è¨€æ¿</h1>
  <label>ä½ çš„åå­—ï¼š<input id="username" placeholder="è«‹è¼¸å…¥æš±ç¨±"></label><br><br>
  <textarea id="msgInput" placeholder="è«‹è¼¸å…¥ç•™è¨€"></textarea><br>
  <button onclick="submitMessage()">é€å‡ºç•™è¨€</button>

  <div id="messages">è¼‰å…¥ä¸­...</div>

  <script>
    // âš ï¸ åƒ…ä¾›æ¸¬è©¦ï¼Œå¯¦éš›ä¸Šè«‹ä½¿ç”¨ OAuth æµç¨‹å– token
    const token = "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";

    const repoOwner = "manlinh";
    const repoName = "timesheet";
    const filePath = "messages.json";

    async function loadMessages() {
      try {
        const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
          headers: { Authorization: `token ${token}` }
        });
        const json = await res.json();
        const content = atob(json.content);
        const messages = JSON.parse(content);
        const list = messages.map(msg =>
          `<div class="msg"><strong>${msg.user}</strong>ï¼š${msg.message}<br><small>${new Date(msg.time).toLocaleString()}</small></div>`
        ).join("");
        document.getElementById("messages").innerHTML = list;
      } catch (e) {
        document.getElementById("messages").innerHTML = "è®€å–ç•™è¨€å¤±æ•—ã€‚";
      }
    }

    async function submitMessage() {
      const user = document.getElementById("username").value.trim();
      const message = document.getElementById("msgInput").value.trim();
      if (!user || !message) return alert("è«‹å¡«å¯«å§“åèˆ‡ç•™è¨€");

      const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
        headers: { Authorization: `token ${token}` }
      });
      const fileData = await res.json();
      const oldMessages = JSON.parse(atob(fileData.content));

      const newMessages = [...oldMessages, { user, message, time: Date.now() }];
      const newContent = btoa(JSON.stringify(newMessages, null, 2));

      await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Update ${filePath}`,
          content: newContent,
          sha: fileData.sha
        })
      });

      alert("âœ… å·²ç•™è¨€ï¼");
      document.getElementById("msgInput").value = "";
      loadMessages();
    }

    loadMessages();
  </script>
</body>
</html>
