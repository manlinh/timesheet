const GITHUB_TOKEN = "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";
const OWNER = "manlinh";
const REPO = "timesheet";

let calendarData = {}, logData = [], currentUser = "", editDate = "";

function setUser() {
  const user = document.getElementById("username").value.trim();
  if (!user) return alert("請輸入使用者名稱");
  localStorage.setItem("calendar_user", user);
  currentUser = user;
  document.getElementById("user-login").innerHTML = `👋 歡迎 ${user}`;
}

function formatDate(d) {
  return d.toISOString().split("T")[0];
}

async function fetchJSON(path) {
  const res = await fetch(`data/${path}`);
  return res.json();
}

async function updateJSON(path, obj) {
  const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`;
  const res = await fetch(url, { headers: { Authorization: `token ${GITHUB_TOKEN}` } });
  const { sha } = await res.json();
  await fetch(url, {
    method: "PUT",
    headers: { "Content-Type": "application/json", Authorization: `token ${GITHUB_TOKEN}` },
    body: JSON.stringify({
      message: `Update ${path}`,
      content: btoa(unescape(encodeURIComponent(JSON.stringify(obj, null, 2)))),
      sha
    })
  });
}

function renderCalendar() {
  const start = new Date(FIXED_YEAR, FIXED_MONTH, 1);
  const end = new Date(FIXED_YEAR, FIXED_MONTH + 1, 0);
  const startDay = start.getDay();
  const daysInMonth = end.getDate();

  const container = document.getElementById("calendar-container");
  let html = "<table><tr><th>日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th></tr><tr>";

  let dayCount = 0;
  for (let i = 0; i < startDay; i++) {
    html += "<td></td>";
    dayCount++;
  }

  for (let date = 1; date <= daysInMonth; date++) {
    const d = new Date(FIXED_YEAR, FIXED_MONTH, date);
    const iso = formatDate(d);
    const entries = (calendarData[iso] || []).map(e =>
      `<div class="entry">${e.user}（${e.time}）<br>${e.subject}</div>`).join("");
    html += `<td onclick="openPopup('${iso}')"><div class="date-label">${date}</div>${entries}</td>`;
    dayCount++;
    if (dayCount % 7 === 0 && date < daysInMonth) html += "</tr><tr>";
  }

  while (dayCount % 7 !== 0) {
    html += "<td></td>";
    dayCount++;
  }

  html += "</tr></table>";
  container.innerHTML = html;
}

function openPopup(date) {
  if (!currentUser) return alert("請先登入");
  editDate = date;
  document.getElementById("popup-date").textContent = date;
  const entry = (calendarData[date] || [])[0] || {};
  document.getElementById("popup-subject").value = entry.subject || "";
  document.getElementById("popup-time").value = entry.time || "";
  document.getElementById("popup").classList.remove("hidden");
}

function closePopup() {
  document.getElementById("popup").classList.add("hidden");
}

async function saveEntry() {
  const subject = document.getElementById("popup-subject").value.trim();
  const time = document.getElementById("popup-time").value.trim();
  if (!calendarData[editDate]) calendarData[editDate] = [];
  calendarData[editDate] = [{ user: currentUser, subject, time }];
  logData.push({ date: editDate, user: currentUser, subject, time, action: "新增/修改", timestamp: Date.now() / 1000 });

  await updateJSON("data/calendar.json", calendarData);
  await updateJSON("data/calendar-log.json", logData);

  closePopup();
  renderCalendar();
  renderLogs();
}

async function deleteEntry() {
  calendarData[editDate] = [];
  logData.push({ date: editDate, user: currentUser, subject: "", time: "", action: "刪除", timestamp: Date.now() / 1000 });

  await updateJSON("data/calendar.json", calendarData);
  await updateJSON("data/calendar-log.json", logData);

  closePopup();
  renderCalendar();
  renderLogs();
}

function renderLogs() {
  const container = document.getElementById("calendar-log");
  container.innerHTML = logData.slice().reverse().map(log =>
    `<div><b>${log.date}</b> - ${log.action} ${log.time ? `(${log.time})` : ""} ${log.subject || "（刪除）"} by ${log.user} 
    <small>${new Date(log.timestamp * 1000).toLocaleString()}</small></div>`
  ).join("");
}

(async () => {
  currentUser = localStorage.getItem("calendar_user") || "";
  if (currentUser) document.getElementById("user-login").innerHTML = `👋 歡迎 ${currentUser}`;
  calendarData = await fetchJSON("calendar.json");
  logData = await fetchJSON("calendar-log.json");
  renderCalendar();
  renderLogs();
})();
